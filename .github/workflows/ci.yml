name: Filare Main CI (release path)

on:
  push:
    branches: [main, beta]
    tags:
      - "v*"
  pull_request:
    branches: [main]

permissions:
  contents: write
  packages: write

env:
  UV_CACHE_DIR: .uv-cache

jobs:
  lint:
    name: "1) Lint (black, prettier)"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Create venv and install deps
        run: |
          uv venv
          uv sync --group dev
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install prettier + mermaid-cli
        run: npm install --global prettier @mermaid-js/mermaid-cli@11.12.0
      - name: Run black
        run: uv run --no-sync black --check src tests
      - name: Run prettier
        run: prettier --check "docs/**/*.{md,html}"
      - name: Check mermaid diagrams
        run: ./scripts/check-mermaid.sh

  test:
    name: "2) Tests"
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
      - name: Install project
        run: |
          uv venv
          uv sync --group dev
      - name: Pytest
        run: uv run --no-sync pytest -m unit --cov=filare --cov-report=term --cov-report=xml --junitxml=junit.xml -o junit_family=legacy
      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload coverage to Codecov
        if: github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: true
          verbose: false
          token: ${{ secrets.CODECOV_TOKEN }}

  build_examples:
    name: "3) Build examples/templates"
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
      - name: Install project
        run: |
          uv venv
          uv sync --group dev
      - name: Build examples
        run: |
          uv run python src/filare/tools/build_examples.py --output-dir outputs --group examples
      - name: Build tutorials
        run: |
          uv run python src/filare/tools/build_examples.py --output-dir outputs --group tutorial
      - name: Build demos
        run: |
          uv run python src/filare/tools/build_examples.py --output-dir outputs --group demos
      - name: Build multi-page
        run: |
          uv run python src/filare/tools/build_examples.py --output-dir outputs --group multi-page
      - name: Upload example artifacts
        uses: actions/upload-artifact@v4
        with:
          name: filare-examples-${{ github.run_attempt }}
          path: outputs/
          overwrite: true

  overlap_check:
    name: "4) Text overlap check"
    needs: build_examples
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/python:v1.56.0-jammy
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Download example artifacts
        uses: actions/download-artifact@v4
        with:
          name: filare-examples-${{ github.run_attempt }}
          path: outputs
      - name: Install project
        run: |
          uv venv
          uv sync --group dev
      - name: Run overlap check
        run: |
          uv run filare-check-overlap "outputs/**/*.html" --viewport 1280x720 --warn-threshold 1 --error-threshold 2

  docs:
    name: "5) Build docs & publish gh-pages"
    needs: overlap_check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Download example artifacts
        uses: actions/download-artifact@v4
        with:
          name: filare-examples-${{ github.run_attempt }}
          path: outputs
      - name: Sync docs dependencies
        run: |
          uv venv
          uv sync --group dev
      - name: Sync README into docs
        run: bash scripts/sync-readme-to-docs.sh
      - name: Prepare site content
        run: |
          mkdir -p docs/examples docs/tutorial
          if [ -d outputs/examples ]; then rsync -a outputs/examples/ docs/examples/; fi
          if [ -d outputs/tutorial ]; then rsync -a outputs/tutorial/ docs/tutorial/; fi
      - name: Build docs (MkDocs)
        run: uv run --no-sync mkdocs build
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  release:
    name: "6) Version bump (semantic-release)"
    needs: docs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      version_changed: ${{ steps.version_check.outputs.changed }}
      new_version: ${{ steps.version_check.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # Capture the current VERSION so we can tell if semantic-release actually bumped it.
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Capture previous tag
        id: prev_tag
        run: |
          prev_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$prev_tag" >> "$GITHUB_OUTPUT"
      - name: Capture previous version
        id: prev_version
        run: |
          echo "prev=$(cat VERSION 2>/dev/null || echo '')" >> "$GITHUB_OUTPUT"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Prepare env
        run: |
          uv venv
          uv pip install python-semantic-release
      - name: Run semantic-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          uv run semantic-release version
          uv run semantic-release publish
      - name: Ensure VERSION updated and pushed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          new_tag=$(git describe --tags --abbrev=0 2>/dev/null || true)
          if [ -z "$new_tag" ]; then
            echo "semantic-release did not create a tag; refusing to continue" >&2
            exit 1
          fi
          new_version=${new_tag#v}
          echo "$new_version" > VERSION
          git add VERSION
          if git diff --cached --quiet; then
            echo "VERSION already up to date ($new_version)"
          else
            git commit -m "chore: align VERSION to ${new_version}"
            git push --follow-tags
          fi
      - name: Compare versions
        id: version_check
        run: |
          prev="${{ steps.prev_version.outputs.prev }}"
          prev_tag="${{ steps.prev_tag.outputs.tag }}"
          new=$(cat VERSION 2>/dev/null || echo "")
          new_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          tag_changed=false
          if [ -n "$new_tag" ] && [ "$new_tag" != "$prev_tag" ]; then
            tag_changed=true
          fi
          if [ "$prev" != "$new" ] && [ -n "$new" ]; then
            version_bumped=true
          else
            version_bumped=false
          fi
          if [ "$version_bumped" = true ] || [ "$tag_changed" = true ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
          echo "new_version=$new" >> "$GITHUB_OUTPUT"

  publish:
    name: "7) Build & publish to PyPI"
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.version_changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Pull latest
        run: |
          git pull --rebase
      - name: Align VERSION with release output
        run: |
          if [ -z "${{ needs.release.outputs.new_version }}" ]; then
            echo "Release job did not provide a new version" >&2
            exit 1
          fi
          echo "${{ needs.release.outputs.new_version }}" > VERSION
      - name: Build dist
        run: |
          uv venv
          uv pip install --python .venv/bin/python build twine
          uv run --no-sync python -m build
      - name: Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: uv run --no-sync twine upload dist/*

  verify_pypi:
    name: "8) Verify package from PyPI"
    needs: publish
    runs-on: ubuntu-latest
    if: needs.release.outputs.version_changed == 'true'
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Install from PyPI
        run: |
          uv venv
          uv pip install --python .venv/bin/python filare
      - name: Check CLI
        run: uv run --no-sync filare --help

  container:
    name: "9) Build & push container"
    needs: publish
    runs-on: ubuntu-latest
    if: needs.release.outputs.version_changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        run: |
          IMAGE=ghcr.io/${{ github.repository }}:latest
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
