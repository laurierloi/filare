name: Filare CI

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:

permissions:
  contents: write

jobs:
  lint:
    name: "1) Lint (black, prettier)"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Create venv and install deps
        run: |
          uv venv
          uv sync --group dev
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install prettier + mermaid-cli
        run: npm install --global prettier @mermaid-js/mermaid-cli@11.12.0
      - name: Run black
        run: uv run --no-sync black --check src tests
      - name: Run prettier
        run: prettier --check "docs/**/*.{md,html}"
      - name: Check mermaid diagrams
        run: ./scripts/check-mermaid.sh

  test:
    name: "2) Tests"
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
      - name: Install project
        run: |
          uv venv
          uv sync --group dev
      - name: Pytest
        run: uv run --no-sync pytest

  build_examples:
    name: "3) Build examples/templates"
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
      - name: Install project
        run: |
          uv venv
          uv sync --group dev
      - name: Build examples
        run: |
          uv run --no-sync python src/filare/tools/build_examples.py
          mkdir -p outputs
          cp -r examples outputs/examples
          cp -r tutorial outputs/tutorial
      - name: Upload example artifacts
        uses: actions/upload-artifact@v4
        with:
          name: filare-examples
          path: outputs/

  docs:
    name: "4) Build docs & publish gh-pages"
    needs: build_examples
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Download example artifacts
        uses: actions/download-artifact@v4
        with:
          name: filare-examples
          path: outputs
      - name: Sync docs dependencies
        run: |
          uv venv
          uv sync --group dev
      - name: Prepare site content
        run: |
          mkdir -p docs/examples docs/tutorial
          if [ -d outputs/examples ]; then rsync -a outputs/examples/ docs/examples/; fi
          if [ -d outputs/tutorial ]; then rsync -a outputs/tutorial/ docs/tutorial/; fi
      - name: Build docs (MkDocs)
        run: uv run --no-sync mkdocs build
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  release:
    name: "5) Version bump (semantic-release)"
    needs: docs
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Prepare env
        run: |
          uv venv
          uv pip install --python .venv/bin/python python-semantic-release
      - name: Run semantic-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          uv run --no-sync semantic-release version
          uv run --no-sync semantic-release publish

  publish:
    name: "6) Build & publish to PyPI"
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Build dist
        run: |
          uv venv
          uv pip install --python .venv/bin/python build twine
          uv run --no-sync python -m build
      - name: Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: uv run --no-sync twine upload dist/*

  verify_pypi:
    name: "7) Verify package from PyPI"
    needs: publish
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Install from PyPI
        run: |
          uv venv
          uv pip install --python .venv/bin/python filare
      - name: Check CLI
        run: uv run --no-sync filare --help

  container:
    name: "8) Build & push container"
    needs: publish
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        run: |
          IMAGE=ghcr.io/${{ github.repository }}:latest
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
