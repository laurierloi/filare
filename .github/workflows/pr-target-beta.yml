name: Enforce beta as default base

on:
  pull_request:
    types: [opened, reopened, edited, synchronize, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-base:
    name: Verify PR targets beta
    runs-on: ubuntu-latest
    steps:
      - name: Enforce beta-first flow
        run: |
          python - <<'PY'
          import json
          import os
          import sys

          with open(os.environ["GITHUB_EVENT_PATH"]) as fh:
              event = json.load(fh)

          pr = event["pull_request"]
          base = pr["base"]["ref"]
          head = pr["head"]["ref"]
          head_repo = pr["head"]["repo"]["full_name"]
          repo = event["repository"]["full_name"]
          labels = {label["name"] for label in pr.get("labels", [])}

          if base == "beta":
              sys.exit(0)

          if base == "main":
              if head == "beta" and head_repo == repo and "validated" in labels:
                  sys.exit(0)
              print(
                  "::error::PRs to main must come from this repo's beta branch and carry a 'validated' label after the validation agent signs off.",
                  file=sys.stderr,
              )
              sys.exit(1)

          print(f"::error::Retarget this PR to base 'beta' (current: {base}).", file=sys.stderr)
          sys.exit(1)
          PY
