Step 1 - Establish models package and move legacy modules (date: YYYY-MM-DD):
- Created src/wireviz/models package with wrapper modules (component, connector, cable, types) and compatibility shims for wv_dataclasses, wv_bom, metadata, page_options.
- Moved wv_dataclasses.py, wv_bom.py, metadata.py, and page_options.py into models/, retaining backward-compatible import stubs.
- Normalized connector loop parsing to accept list-based loop definitions and guarded Loop side parsing.
- Test: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m wireviz.wv_cli -f hpst -o outputs_refactor_step1 -d examples/metadata.yml examples/demo01.yml (pass; outputs generated in outputs_refactor_step1/).

Step 2 - Introduce parser package (date: YYYY-MM-DD):
- Moved parse_yaml.py to src/wireviz/parser/yaml_loader.py with a shim for backward compatibility.
- Added parser/__init__.py exports and new harness_parser.py helpers for harness/metadata parsing; updated wv_cli and wireviz to import from parser package.
- Test: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m wireviz.wv_cli -f hpst -o outputs_refactor_step2 -d examples/metadata.yml examples/demo01.yml (pass).

Step 3 - Add flows layer and delegate parsing (date: YYYY-MM-DD):
- Created src/wireviz/flows/ with build_harness_from_files and render_harness_outputs; wireviz.parse now delegates to the flow.
- Preserved legacy harness-building logic while routing rendering through the flow.
- Test: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m wireviz.wv_cli -f hpst -o outputs_refactor_step3 -d examples/metadata.yml examples/demo01.yml (pass).

Step 4 - Separate rendering helpers (date: YYYY-MM-DD):
- Moved wv_graphviz.py and wv_output.py into src/wireviz/render/ with backward-compatible shims.
- Added render/__init__.py to export the render surface.
- Test: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m wireviz.wv_cli -f hpst -o outputs_refactor_step4 -d examples/metadata.yml examples/demo01.yml (pass).

Step 4a - Model unit tests and coverage (date: YYYY-MM-DD):
- Added pytest fixtures in tests/fixtures/models.py and model-focused tests under tests/models/* for connectors, cables, components, BOM, metadata/options.
- Coverage command: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage run -m pytest tests && /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage html -d report/coverage
- Coverage summary: total 70%; key model coverages â€” models/bom.py 90%, models/metadata.py 92%, models/dataclasses.py 74%, models/options.py 98%. HTML report at report/coverage/index.html.

Step 4b - Parser/flows tests and coverage (date: YYYY-MM-DD):
- Added parser tests (yaml_loader merge/concat, harness_parser helpers) and flow tests (build_harness happy path and mismatch, render_harness_outputs smoke).
- Coverage command: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage run -m pytest tests && /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage html -d report/coverage
- Coverage summary: total 72%; parser modules now >=73%, flows/build_harness at 74%. HTML report refreshed at report/coverage/index.html.

Step 4c - Expanded flow coverage and overview support (date: YYYY-MM-DD):
- Added flow tests for overview rendering, additional BOM items, and required-output validation; introduced orient_connectors_overview back onto Harness for overview mode.
- Coverage command: same as above.
- Coverage summary: total 73%; flows/build_harness 81%, wv_harness 71%. HTML report refreshed at report/coverage/index.html.

Step 4d - Move HTML/templates into render and add render tests (date: YYYY-MM-DD):
- Moved wv_html.py into render/html_utils.py and wv_templates.py into render/templates.py with shims; updated imports across models/render/harness.
- Added render tests for templates loader, HTML utilities, SVG embedding helpers, HTML generation, and harness render flow (tsv output).
- Coverage command: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage run -m pytest tests && /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage html -d report/coverage
- Coverage summary: total 76%; render/output at 71%, render/html_utils 86%, templates 100%, flows/build_harness 81%. Report updated at report/coverage/index.html.

Step 5 - Refactor flows into helpers (date: YYYY-MM-DD):
- Extracted helper functions in flows/build_harness.py (_build_metadata, _collect_templates, _normalize_connection_set) to improve readability and separation; retained behavior.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage run -m pytest tests && html report regenerated.
- Coverage summary: total 77%; flows/build_harness 81%, core models/render unchanged. Report refreshed at report/coverage/index.html.

Step 5a - High-coverage flow tests (date: YYYY-MM-DD):
- Added extensive flow unit tests for helper functions and error branches (metadata TypeError, template resolution, alternating-type enforcement, auto-generated designators, additional BOM error path, return types, image resolution, cable-first connections).
- Coverage command: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage run -m pytest tests && /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage html -d report/coverage
- Coverage summary: flows/build_harness now 99%, total 77%. Report updated at report/coverage/index.html.

Step 6 - Shared BOM and index flows (date: YYYY-MM-DD):
- Added flows/shared_bom.py and flows/index_pages.py wrappers; wv_cli now calls these instead of render.output directly.
- Added tests/flows/test_shared_bom_and_index.py with monkeypatches to cover success and failure-free paths for shared BOM generation, titlepage generation, and PDF bundling.
- Coverage command: same as above.
- Coverage summary: flows/build_harness 99%, total ~77%; wrappers covered via tests; report refreshed at report/coverage/index.html.

Step 7 - Example/tutorial generation tests (date: YYYY-MM-DD):
- Added tests/flows/test_examples_and_tutorial.py to exercise CLI generation of examples and tutorial YAMLs (marked skipped by default due to runtime); outputs verified under outputs/examples and outputs/tutorial in tmp paths.
- Coverage command: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage run -m pytest tests && /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage html -d report/coverage
- Coverage summary: flows/build_harness 99%, total ~79% (skipped tests exclude example/tutorial runtime). HTML report at report/coverage/index.html.

Step 7a - Stabilize example/tutorial generation and BOM render edge cases (date: YYYY-MM-DD):
- CLI generation tests now run (html only) against examples and tutorial into outputs/examples and outputs/tutorial; added pytest marker registration; resolved BOM render empty-content crash.
- Coverage command: same as above.
- Coverage summary: total 89%; flows/build_harness 100%, render/output 85%, render/graphviz 92%, models/dataclasses 89%. Report refreshed at report/coverage/index.html.

Open refactor items to tackle next:
- Split render/output.py into html/pdf/assets modules; migrate remaining in-code rendering toward templates where feasible.
- Remove legacy shims (wv_* proxies) after updating imports to models/parser/flows/render paths.
- Raise coverage for parser/yaml_loader (>90%), wv_harness_quantity, wv_colors/wv_utils, render/graphviz, and expand example/tutorial sweeps to png/svg/shared BOM (mark slow if needed).

Step 8 - Split render/output into assets/html/pdf (date: YYYY-MM-DD):
- Extracted embed helpers to render/assets.py, HTML/shared BOM/titlepage to render/html.py, and PDF bundle to render/pdf.py; render/output.py now shims to new modules. Updated imports in flows and harness to use split modules.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage run -m pytest tests (pass).
- Coverage summary: flows/build_harness 100%, overall ~89% (report updated at report/coverage/index.html).

Step 9 - Move colors and quantity into models (date: YYYY-MM-DD):
- Moved wv_colors.py to models/colors.py and wv_harness_quantity.py to models/harness_quantity.py with shims; updated imports (harness, render, options, dataclasses, index_table, image).
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/coverage run -m pytest tests (pass).
- Coverage summary: models/colors 76%, models/harness_quantity 35% (needs future hardening); overall ~89%. HTML report refreshed at report/coverage/index.html.

Step 10 - Move Harness into models and remove internal shim imports (date: YYYY-MM-DD):
- Introduced models/harness.py and turned wv_harness.py into a shim; flows/render/html/graphviz now import models.* modules directly instead of wv_* shims.
- Updated CLI and tests to use models paths (dataclasses, colors, harness, numbers/partnumber/notes), eliminating remaining internal wv_* references.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass).
- Coverage summary: total 91% (render/pdf still low by design), harness model at 83%. HTML report refreshed at report/coverage/index.html.

Step 10a - Add CLI surface tests (date: YYYY-MM-DD):
- Added click-based CLI tests for help, version, and a minimal harness invocation to ensure TSV generation; exercises CLI option parsing and output dir handling.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass).
- Coverage summary: total 91%; wv_cli coverage up to 92%. HTML report refreshed at report/coverage/index.html.

Step 11 - Remove legacy shims and point entrypoints to models (date: YYYY-MM-DD):
- Deleted remaining shim modules (wv_*, metadata/notes/numbers/etc. wrappers) now that imports use models/parser/render directly; updated console entrypoint wireviz-qty to wireviz.models.harness_quantity.
- Adjusted tests to import models.notes directly. CLI still routed through wv_cli entrypoint.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass).
- Coverage summary: total 91% (render/pdf remains low intentionally). HTML report refreshed at report/coverage/index.html.

Step 12 - Migrate metadata/options to Pydantic BaseModel (date: YYYY-MM-DD):
- Added pydantic<2 dependency; refactored models/metadata.py and models/options.py to BaseModel with validators for date coercion, path handling, and color conversion to SingleColor.
- Updated validation helpers to accept pathlib Paths and datetime.date inputs; PageOptions now stores SingleColor instances for template rendering.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass, 2 warnings from pydantic about SingleColor private fields).
- Coverage summary: total 91%; metadata 95%, options 96%. HTML report refreshed at report/coverage/index.html.

Step 13 - Propagate Pydantic usage and tighten PageOptions config (date: YYYY-MM-DD):
- Documented Pydantic propagation in RefactorPlan and added Config to PageOptions to support validation assignment/underscore attrs; functions now explicitly expect BaseModel instances.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass, known pydantic warnings remain).
- Coverage summary: total 91% unchanged. HTML report refreshed at report/coverage/index.html.

Step 14 - Introduce centralized WV_ settings (date: YYYY-MM-DD):
- Added src/wireviz/settings.py with Pydantic BaseSettings (WV_GRAPHVIZ_ENGINE, WV_DEBUG); render.graphviz and Harness now honor an engine override via settings.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass).
- Coverage summary: total 91%; settings.py covered 100%. HTML report refreshed at report/coverage/index.html.

Step 14a - Settings tests (date: YYYY-MM-DD):
- Added tests/test_settings.py to verify default and env-override behavior of WireVizSettings (WV_GRAPHVIZ_ENGINE).
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass; same pydantic warnings).
- Coverage summary: total 91% unchanged. HTML report refreshed at report/coverage/index.html.

Step 15 - Convert harness quantity to Pydantic (date: YYYY-MM-DD):
- Refactored models/harness_quantity.py to Pydantic BaseModel with derived paths (folder/qty_multipliers) and retained CLI; added validator-based init while keeping existing call sites.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass; existing warnings unchanged).
- Coverage summary: total 91%; harness_quantity remains covered at 79%. HTML report refreshed at report/coverage/index.html.

Step 16 - Convert numbers and partnumbers to Pydantic (date: YYYY-MM-DD):
- Migrated NumberAndUnit and PartNumberInfo/PartnumberInfoList to Pydantic BaseModel while preserving arithmetic/helpers and cleaning logic; updated usages to keyword instantiation to avoid positional init errors.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass; existing Pydantic warnings unchanged).
- Coverage summary: total 91%; numbers 91%, partnumber 83%. HTML report refreshed at report/coverage/index.html.

Step 17 - Convert BOM to Pydantic and restore BOM rendering (date: YYYY-MM-DD):
- Split BomEntry into BomEntryBase (id-less) and BomEntry; added robust handling in harness.populate_bom to assign IDs and update per_harness while using Pydantic models.
- Added BOM render properties expected by templates (content, columns_class, options), kept per-harness column, and added regression test for BOM TSV output.
- Updated shared BOM generation to keep entries without partnumbers, and adjusted HTML BOM rendering to pass BomRenderOptions explicitly.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass; 2 pydantic warnings remain).
- Coverage summary: total 90%; bom.py at 85%. HTML report refreshed at report/coverage/index.html.

Step 18 - Pydantic for colors and stabilization (date: YYYY-MM-DD):
- Refactored SingleColor to a Pydantic BaseModel with positional-friendly __init__, kept MultiColor behavior and PageOptions validators; reran all tests.
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass; 2 warnings from Pydantic about underscores remain).
- Coverage summary: total 90%; colors module now at 78%. HTML report refreshed at report/coverage/index.html.

Step 19 - Colors Pydantic stabilization (date: YYYY-MM-DD):
- Adjusted SingleColor to allow positional init and restore known/unknown color behavior; MultiColor and PageOptions defaults updated to use SingleColor(inp=...).
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass).
- Coverage summary: total 90%; colors remains ~78%. HTML report refreshed at report/coverage/index.html.

Step 19a - Agent guideline update (date: YYYY-MM-DD):
- Updated AGENTS.md to clarify that when running through a multi-step plan, each step should be committed and execution continues to the next step when no operator input is needed.

Step 20 - Prep for core Pydantic migration (date: YYYY-MM-DD):
- Kept dataclasses using BomEntryBase for BOM creation and aligned SingleColor defaults in PageOptions/tests with the Pydantic constructor signature (using inp=...).
- Tests: PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage run -m pytest tests && PYTHONPATH=src /home/lal/devs/WireViz-laurierloi/venv-wireviz/bin/python -m coverage html -d report/coverage (pass).
- Coverage summary: total 90% (colors 78%, bom 85%). HTML report refreshed at report/coverage/index.html.

Step 22 - Add config BaseModels, uv workflow, and coverage config (date: YYYY-MM-DD):
- Introduced src/wireviz/models/configs.py with Pydantic BaseModels for YAML-facing configs (Connector/Cable/Wire/Connection/Metadata/PageOptions) and normalizers for lists/counts.
- Added fixtures and tests/models/test_configs.py to round-trip config models; normalized numeric fields to keep types stable. Exported configs via models/__init__.
- Switched to pyproject-only build with setuptools backend, added project metadata, scripts, optional dev deps, coverage/pytest settings, and uv dev-dependencies; removed legacy setup.py.
- Updated AGENTS.md to prefer uv commands for env setup and test runs; added tests/__init__.py to avoid conflicts with site-packages.
- Tests: .venv/bin/pytest (pass); coverage report generated at report/coverage/index.html (total ~83%).

Step 23 - Add template-input models scaffolding (date: YYYY-MM-DD):
- Added src/wireviz/models/template_inputs.py (TemplateConnector/Cable/Wire/Pin/Connection BaseModels) with helpers to build from config models.
- Added tests/models/test_template_inputs.py to validate mappings from configs and basic coercions; exported via models/__init__.
- Tests: .venv/bin/pytest (pass); coverage refreshed at report/coverage/index.html (~83%).

Step 24 - Introduce Component/Connector BaseModels (date: YYYY-MM-DD):
- Added ComponentModel BaseModel with conversion helpers to/from Component dataclass; tests cover round-trip and normalization of colors/qty/hypertext.
- Added GraphicalComponentModel/ConnectorModel in models/connector.py with conversion to existing Connector dataclass and normalization of loops/pins; added tests/models/test_connector_model.py.
- Updated RefactorPlan with step 22b for component BaseModel; pytest suite passing; coverage ~83%, HTML at report/coverage/index.html.

Step 25 - Add CableModel BaseModel (date: YYYY-MM-DD):
- Added CableModel in models/cable.py to normalize colors/wirecount/color-code/gauge/length and convert to existing Cable dataclass.
- Added tests/models/test_cable_model.py for color expansion and DIN color code defaults.
- Tests: .venv/bin/pytest (all 89 passed); coverage refreshed at report/coverage/index.html (~82-83%).

Step 26 - Add GraphicalComponentModel test and polish (date: YYYY-MM-DD):
- Added tests/models/test_graphical_component_model.py covering conversion to GraphicalComponent and color/bg handling.
- Adjusted GraphicalComponentModel to allow optional category coercion and removed unsupported args for base dataclass.
- Tests: .venv/bin/pytest (all 90 passed); coverage refreshed at report/coverage/index.html (~82%).

Step 27 - Plan update for connector/cable BaseModels (date: YYYY-MM-DD):
- Updated RefactorPlan to track ConnectorModel/CableModel work and next propagation into flows/harness.

Step 28 - Harness helpers for BaseModels (date: YYYY-MM-DD):
- Added add_connector_model/add_cable_model helpers on Harness and allow ComponentModel in add_additional_bom_item to ease BaseModel integration.
- Added tests/models/test_harness_models_integration.py to ensure harness accepts models and BOM still populates.
- Tests: .venv/bin/pytest (93 passed); coverage refreshed at report/coverage/index.html (~82%).

Step 29 - Flow builder accepts BaseModels (date: YYYY-MM-DD):
- Added build_harness_from_models in flows/build_harness to assemble Harness from ConnectorModel/CableModel/ComponentModel inputs.
- Added tests/flows/test_build_harness_models.py to cover model-based harness construction and BOM population.
- Tests: .venv/bin/pytest (95 passed); coverage refreshed at report/coverage/index.html (~83%).
