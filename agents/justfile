# Justfile for filare-agent orchestrator tooling

agents-help:
  @echo "Agent recipes:"
  @echo "  just orchestrator-validate manifest=agents/manifest/test.yml"
  @echo "  just orchestrator-start manifest=agents/manifest/test.yml [session=<id>] [execute=true]"
  @echo "  just orchestrator-resume-all"
  @echo "  just orchestrator-test"
  @echo "  just codex-container-build   # build codex-ready Docker image"
  @echo "  just codex-container-sh      # start shell in codex Docker image (bind-mount repo)"
  @echo "  just codex-container-run     # run codex container with workspace/env/ssh key"

orchestrator-validate manifest session="":
  bash -lc 'set -eu; MANIFEST="{{manifest}}"; MANIFEST="${MANIFEST#manifest=}"; cd ..; source scripts/agent-setup.sh; export PYTHONPATH="agents/src:src"; uv run python -m orchestrator.cli validate "$MANIFEST" {{ if session != "" { "--session " + session } else { "" } }}'

orchestrator-start manifest session="" execute="false":
  bash -lc 'set -eu; MANIFEST="{{manifest}}"; MANIFEST="${MANIFEST#manifest=}"; cd ..; source scripts/agent-setup.sh; export PYTHONPATH="agents/src:src"; uv run python -m orchestrator.cli start "$MANIFEST" {{ if session != "" { "--session " + session } else { "" } }} {{ if execute == "true" { "--execute" } else { "" } }}'

orchestrator-resume-all:
  bash -lc 'cd ..; source scripts/agent-setup.sh; export PYTHONPATH="agents/src:src"; uv run python -m orchestrator.cli resume-all'

orchestrator-test:
  bash -lc 'cd ..; source scripts/agent-setup.sh; export PYTHONPATH="agents/src:src"; uv run pytest agents/tests -m agent -q'

codex-container-build:
  bash -lc 'cd ..; source scripts/agent-setup.sh; docker build -f docker/Dockerfile.codex -t filare-codex .'

codex-container-sh:
  bash -lc 'cd ..; source scripts/agent-setup.sh; docker run --rm -it \
    -v "$PWD":/home/agent/workspace \
    -v "$HOME"/.codex:/home/agent/.codex \
    -w /home/agent/workspace \
    --user $(id -u):$(id -g) \
    filare-codex bash'

codex-container-run:
  bash -lc 'cd ..; source scripts/agent-setup.sh; SSH_KEY=${SSH_KEY:?set SSH_KEY}; ENV_FILE=${ENV_FILE:?set ENV_FILE}; WORKSPACE=${WORKSPACE:-$PWD}; ./scripts/run_codex_container.sh --ssh-key "$SSH_KEY" --env-file "$ENV_FILE" --workspace "$WORKSPACE"'
