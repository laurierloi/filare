# Codex container lifecycle helpers for orchestrator

uid: FEAT-TOOLS-0003
status: BACKLOG
priority: medium
owner_role: TOOLS
estimate: TBD
dependencies: [FEAT-TOOLS-0002]
risk: medium
milestone: backlog

## Summary

Provide scripted entrypoints that let an ORCHESTRATOR agent consistently build, start, and stop codex containers per agent session. Wrap existing tasks (`just codex-container-build`, `just codex-container-run`, `scripts/run_codex_container.sh`) with parameter validation, tagging, and metadata capture so multiple sessions can run in parallel without collisions.

## Motivation

- Avoid ad-hoc Docker invocations when spinning up many agent sessions.
- Ensure per-agent workspaces, SSH keys, and `.env` files are bound correctly and auditably.
- Prepare for automation by exposing a thin Python API that mirrors the shell commands.

## Proposal

- Maintain `just codex-container-build` as the canonical image build; add optional tag argument in the library wrapper to allow version pinning (default `filare-codex`).
- Expose a Python function `launch_container(session: AgentSessionConfig)` under `agents/src/orchestrator/runtime.py` that shells out to `scripts/run_codex_container.sh` with derived args (`--workspace`, `--ssh-key`, `--env-file`, optional `--image`).
- Add container labels (via `--label`) for `filare.session`, `filare.role`, and `filare.owner` so cleanup and introspection are easy.
- Provide stop/cleanup helpers that match on labels and remove associated temp SSH mounts.
- Record container IDs and workspace paths in a small state file per session (e.g., `outputs/agents/<role>/<session-id>/state.json`).
- Extend `just` with orchestration-friendly wrappers (e.g., `just codex-session-start --manifest ...`, `just codex-session-stop --session ...`) that delegate to the Python CLI; mirror these in `agents/extra_commands.yml` for Codex discoverability. Do not duplicate definitions already generated by `scripts/generate_filare_agent_commands.py`; prefer feeding new `just` targets into that generator. Keep agent-scoped recipes in `agents/justfile` and root wrappers only for command generation.

## Implementation Notes

- Prefer `subprocess.run` with explicit argv and timeouts; avoid interactive flags except when allocated by orchestrator.
- When seeding workspaces, reuse `scripts/run_codex_container.sh` rsync logic rather than duplicating it.
- Enforce that host UID/GID is forwarded (already done in script) and surface any failures cleanly back to the orchestrator.

## Verification & Validation

- Build image successfully from a clean checkout using `just codex-container-build`.
- Launch two containers with different workspaces and env files; confirm labels and mounted paths via `docker ps --filter label=filare.session`.
- Stop containers via library helper; confirm no orphaned processes or temp SSH dirs remain.
- Add optional `pytest` coverage under `agents/tests/` gated by an `agent` marker (off by default) to exercise the launch/label/cleanup flows in a controlled environment.

## Dependencies

- Uses `docker/Dockerfile.codex`, `scripts/run_codex_container.sh`, and just recipes as the base tooling.
- Consumed by higher-level session/IO orchestration in `FEAT-TOOLS-0005` and `FEAT-TOOLS-0006`.

## Progress / Notes

- Added dry-run command assembly and registry recording in `agents/src/orchestrator/runtime.py` plus CLI `start` (defaults to dry-run) and `just` wrappers (`orchestrator-validate/start/resume-all`).
- Tests in `agents/tests/test_runtime.py` cover command assembly and state recording (agent-marked).
- Next: extend script/wrapper to inject container labels and add `just`/generator-backed shortcuts once execution flow is finalized.
