# `filare-agents` library and CLI wrapper

uid: FEAT-TOOLS-0008
status: BACKLOG
priority: medium
owner_role: TOOLS
estimate: TBD
dependencies: [FEAT-TOOLS-0002, FEAT-TOOLS-0003, FEAT-TOOLS-0004, FEAT-TOOLS-0005, FEAT-TOOLS-0006, FEAT-TOOLS-0007]
risk: medium
milestone: backlog

## Summary

Ship a Python helper library under `src/filare/agents/` plus a Typer CLI `filare-agents` (invoked via `uv run filare-agents ...`) that exposes orchestrator actions: validate manifests, start/stop sessions, send/stream messages, and manage operator prompts.

## Motivation

- Give the ORCHESTRATOR agent a scriptable interface instead of hand-written Docker commands.
- Provide humans with a quick CLI for debugging sessions (list, tail, stop).
- Keep tooling co-located with Filare while avoiding changes to runtime logic.

## Proposal

- Library modules under `agents/src/orchestrator/`:
  - `config.py` (manifest parsing from `FEAT-TOOLS-0004`),
  - `runtime.py` (container launch/stop from `FEAT-TOOLS-0003`, registry from `FEAT-TOOLS-0005`),
  - `io.py` (message routing from `FEAT-TOOLS-0006`),
  - `feedback.py` (operator queue from `FEAT-TOOLS-0007`),
  - `cli.py` (Typer app).
- CLI commands (initial set):
  - `filare-agents validate --manifest configs/agents/demo.yml`
  - `filare-agents start --manifest ... [--session-id ...]`
  - `filare-agents stop --session <id>` / `restart` / `list`
  - `filare-agents send --session <id> --text "..."` / `tail --session <id> [--follow]`
  - `filare-agents feedback list|approve|reject`
  - `filare-agents resume-all` to reconnect IO streams to existing containers/tmux sessions (optionally issuing `codex resume <session>` inside each session when available).
- Common flags: `--workspace`, `--env-file`, `--ssh-key`, `--image`, `--transcript-dir`, `--dry-run`.
- Packaging: reuse existing `uv run` workflow; no new dependencies beyond standard library + Typer (already in repo).
- Add matching `just` shortcuts (e.g., `just codex-orchestrator-start`, `...-stop`, `...-tail`, `...-feedback`) that simply call `uv run filare-agents ...`; register them in `agents/extra_commands.yml` so Codex sessions surface the helpers in-context. Ensure no duplication with commands auto-generated by `scripts/generate_filare_agent_commands.py`â€”the generator should ingest the new `just` targets instead of hand-adding overlapping entries. Keep the canonical recipes in the root `justfile` for generation/discoverability.

## Verification & Validation

- CLI help prints commands without error under `uv run filare-agents --help`.
- Dry-run `start` shows docker command that would be executed without launching.
- End-to-end: start two sessions from a manifest, send a message, tail logs, then stop both; transcripts written to `outputs/agents/...`.
- Feedback commands read/write the prompt queue and update session state accordingly.
- Optional: add CLI-level pytest coverage under `agents/tests/` with `-m agent` to mock docker and assert command wiring (start/stop/send/tail/feedback).

## Dependencies

- Aggregates functionality from `FEAT-TOOLS-0003` through `FEAT-TOOLS-0007`.
- Consumers: ORCHESTRATOR agent scripts, local devs supervising agent fleets.

## Progress / Notes

- Implemented initial Typer CLI (`agents/src/orchestrator/cli.py`) with `validate`, `start` (dry-run by default), and `resume-all`; commands locate repo root from the manifest directory. Added `just` wrappers for these commands.
- Added standalone `agents/pyproject.toml` to scope orchestrator dependencies/commands without touching Filare runtime.
- Orchestrator commands now live in the root `justfile` for discoverability and to feed the command generator.
- Container launch path now uses `python -m orchestrator.run_container` (wired into `just codex-container-run` and orchestrator runtime) instead of the shell script.
- Added agent-marked tests for config/runtime pieces; CLI not yet covered.
- Added CLI commands and just wrappers for send/snapshot, feedback queue, dashboard, and test runner (`orchestrator-test`); stop/restart/tail still pending.
- Next: add stop/restart/tail commands and wire generator integration.
